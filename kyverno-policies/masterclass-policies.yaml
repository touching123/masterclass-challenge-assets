apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resources
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-memory-requests-limits
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "CPU and memory requests and limits are required."
        pattern:
          spec:
            containers:
              - resources:
                  requests:
                    memory: "?*"
                    cpu: "?*"
                  limits:
                    memory: "?*"
                    cpu: "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-probes
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-liveness-readiness
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Liveness and readiness probes are required."
        pattern:
          spec:
            containers:
              - livenessProbe:
                  "?*": "?*"
                readinessProbe:
                  "?*": "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-labels
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-standard-labels
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - Service
      validate:
        message: "Standard labels app.kubernetes.io/name and app.kubernetes.io/instance are required."
        pattern:
          metadata:
            labels:
              app.kubernetes.io/name: "?*"
              app.kubernetes.io/instance: "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-non-root
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-run-as-non-root
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Running containers as root is not allowed. Set securityContext.runAsNonRoot to true."
        pattern:
          spec:
            containers:
              - securityContext:
                  runAsNonRoot: true

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-drop-all
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-drop-all
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Containers must drop all capabilities. Set securityContext.capabilities.drop to ['ALL']."
        pattern:
          spec:
            containers:
              - securityContext:
                  capabilities:
                    drop:
                      - "ALL"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-non-default-sa
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: check-service-account
      match:
        any:
          - resources:
              kinds:
                - Pod
      validate:
        message: "Using the 'default' service account is not allowed. A specific ServiceAccount must be configured."
        pattern:
          spec:
            =(serviceAccountName): "!default"
